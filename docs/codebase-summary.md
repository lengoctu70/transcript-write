# Codebase Summary

**Version:** 0.4.0
**Phase:** 4 - Validation & Output Complete
**Last Updated:** 2025-12-25
**Generated by:** repomix v1.10.2

---

## Project Structure

```
transcript_write/
├── docs/                           # Documentation (this phase)
│   ├── project-overview-pdr.md
│   ├── code-standards.md
│   ├── system-architecture.md
│   └── codebase-summary.md
│
├── src/                            # Source code
│   ├── __init__.py
│   ├── transcript_parser.py        # SRT/VTT parsing
│   ├── chunker.py                  # Smart chunking with context
│   ├── llm_processor.py            # Claude API integration
│   ├── validator.py                # Output validation rules
│   ├── markdown_writer.py          # Markdown output generation
│   └── cost_estimator.py           # API cost estimation
│
├── prompts/                        # Claude system prompts
│   └── base_prompt.txt
│
├── tests/                          # Test suite
│   ├── test_parser.py              # Parser tests
│   ├── test_chunker.py             # Chunker tests
│   ├── test_llm_processor.py       # LLM processor tests
│   ├── test_validator.py           # Validator tests
│   ├── test_writer.py              # Writer tests
│   ├── test_cost_estimator.py      # Cost estimator tests
│   └── fixtures/
│       └── sample.srt              # Test fixture
│
├── output/                         # Generated cleaned transcripts
│
├── plans/                          # Development planning
│   ├── 251224-1840-transcript-cleaner-mvp/
│   │   ├── plan.md
│   │   ├── phase-01-setup.md
│   │   ├── phase-02-parsing-chunking.md
│   │   ├── phase-03-llm-integration.md
│   │   ├── phase-04-validation-output.md
│   │   ├── phase-05-streamlit-ui.md
│   │   └── phase-06-testing-polish.md
│   └── reports/
│
├── requirements.txt                # Python dependencies
├── .env.example                    # Configuration template
├── .gitignore                      # Git exclusions
└── README.md                       # Project overview
```

---

## Current State (Phase 4)

### Files Created

**Phase 1:**
1. **requirements.txt** - Python package dependencies
2. **.env.example** - Environment configuration template
3. **.gitignore** - Version control exclusions
4. **src/__init__.py** - Python package initialization
5. **prompts/base_prompt.txt** - Claude system prompt
6. **docs/** - Documentation suite

**Phase 2:**
7. **src/transcript_parser.py** - SRT/VTT parser (127 lines)
8. **src/chunker.py** - Smart chunker with context (122 lines)
9. **tests/test_parser.py** - Parser unit tests (61 lines)
10. **tests/test_chunker.py** - Chunker unit tests (57 lines)
11. **tests/fixtures/sample.srt** - Test fixture (11 lines)

**Phase 3:**
12. **src/llm_processor.py** - Claude API integration (249 lines)
13. **tests/test_llm_processor.py** - LLM processor unit tests (243 lines)

**Phase 4:**
14. **src/validator.py** - Rule-based validation for cleaned output (220 lines)
15. **src/markdown_writer.py** - Markdown output generation (139 lines)
16. **src/cost_estimator.py** - API cost estimation utility (127 lines)
17. **src/__init__.py** - Updated exports for new modules (24 lines)
18. **tests/test_validator.py** - Validator unit tests (294 lines)
19. **tests/test_writer.py** - Writer unit tests (479 lines)
20. **tests/test_cost_estimator.py** - Cost estimator unit tests (355 lines)

### Key Metrics
| Metric | Value |
|--------|-------|
| Total Files | 20+ |
| Directories | 5 |
| Python Files | 7 (src) + 6 (tests) |
| Configuration Files | 3 |
| Documentation Files | 4 |
| Total Lines of Code | ~2,600 |
| Largest File | test_writer.py (479 lines) |
| Test Coverage | 94 passing tests across all modules |

---

## Dependencies (requirements.txt)

### Core Framework
```
streamlit>=1.29.0
  - Web UI framework for interactive application
  - Version: Stable, supports latest features
```

### LLM Integration
```
anthropic>=0.75.0
  - Official Anthropic Python SDK
  - Required for Claude API access
  - Includes retry and error handling utilities
```

### Parsing & Subtitles
```
pysrt>=1.1.2
  - SRT subtitle file parser
  - Handles timestamp parsing and normalization

webvtt-py>=0.4.6
  - WebVTT subtitle format support
  - Complements pysrt for format coverage
```

### Utilities
```
python-dotenv>=1.0.0
  - Environment variable management
  - Secure API key loading from .env

tiktoken>=0.5.2
  - OpenAI tokenizer (works with GPT/Claude)
  - Accurate token counting for chunks
  - Critical for cost estimation

tenacity>=8.2.3
  - Retry library with exponential backoff
  - Handles transient API failures
  - Improves reliability of API calls
```

### Development & Testing
```
pytest>=7.4.3
  - Testing framework
  - Includes fixtures and parametrization
  - For unit and integration tests
```

### Dependency Philosophy
- **Minimal:** Only essential packages included
- **Stable:** Well-maintained, widely-used libraries
- **Clear Purposes:** Each dependency solves a specific problem
- **Version Flexibility:** Allows patch updates automatically

---

## Configuration Files

### .env.example
```env
ANTHROPIC_API_KEY=sk-ant-xxx
# Optional: OPENAI_API_KEY for future support
```
**Purpose:** Template for required API credentials
**Status:** ✓ Complete
**Notes:** Real .env file is .gitignored (not in repo)

### .gitignore
**Excludes:**
- `.env` - API keys and secrets
- `.venv/`, `venv/` - Virtual environments
- `output/*.md`, `output/*.json` - Generated files
- `__pycache__/`, `*.pyc` - Compiled Python
- `.pytest_cache/` - Test artifacts
- `.DS_Store`, `**/.DS_Store` - macOS artifacts
- `.vscode/`, `.idea/` - IDE configurations

**Status:** ✓ Complete with Phase 1 recommendations

---

## Base Prompt (prompts/base_prompt.txt)

### Summary
A comprehensive system prompt for Claude that defines the rules for cleaning lecture transcripts into study-ready materials for Vietnamese learners.

### Key Sections
1. **ROLE** - Position Claude as senior transcript editor
2. **MISSION** - Aggressive cleaning while preserving meaning
3. **CORE PRINCIPLES** - Rewrite freely, preserve content, improve clarity
4. **LANGUAGE RULES** - English output, Vietnamese audience, keep technical terms
5. **QUESTION HANDLING** - Convert rhetorical questions to declarative statements
6. **EXAMPLES HANDLING** - Keep helpful examples, remove conversational ones
7. **NOISE REMOVAL** - Remove ALL filler, hesitations, and redundant content
8. **STRUCTURE RULES** - Organize by concept, clear paragraphs, improve flow
9. **TIMESTAMPS** - Keep only start timestamps [00:01:15] format
10. **OUTPUT FORMAT** - Markdown, clean paragraphs, no commentary
11. **CONTEXT HANDLING** - Handle chunk continuity with context from previous sections

### Template Variables
- `{{fileName}}` - Source file name (substituted during processing)
- `{{chunkText}}` - Transcript chunk to process (substituted during processing)

### Metrics
- Lines: 121
- Tokens: 629 (based on tiktoken count)
- Size: 2,974 characters

**Status:** ✓ Extracted from README.md, ready for use

---

## Source Code Status

### src/__init__.py
Empty Python package initialization file.

### src/transcript_parser.py (NEW - Phase 2)
**Classes:** `TranscriptParser`, `TranscriptSegment`

**Features:**
- Auto-detect SRT/VTT format
- Parse to structured `TranscriptSegment` dataclass
- Remove HTML tags and duplicates
- Convert to timestamped plain text
- Handle Streamlit file uploads (bytes)

**Key Methods:**
- `parse(file_path)` - Auto-detect and parse
- `parse_from_bytes(content, filename)` - For file uploads
- `to_plain_text(segments)` - Format with timestamps

### src/chunker.py (NEW - Phase 2)
**Classes:** `SmartChunker`, `Chunk`

**Features:**
- Split at sentence/paragraph boundaries
- Context buffer between chunks
- Timestamp extraction per chunk
- Configurable chunk size and overlap

**Key Methods:**
- `chunk_transcript(text)` - Split with context preservation
- `full_text_for_llm` - Build text with context markers

**Chunking Strategy:**
1. Paragraph breaks (double newline)
2. Sentence boundaries (. ! ?)
3. Timestamp markers [HH:MM:SS]
4. Fallback to target position

### src/llm_processor.py (Phase 3)
**Classes:** `LLMProcessor`, `ProcessedChunk`, `ProcessingError`

**Features:**
- Claude API integration with anthropic SDK
- Retry logic with tenacity (3 attempts, exponential backoff)
- Token counting and cost calculation per request
- Support for multiple Claude models (Sonnet, Haiku)
- Progress callback for batch processing
- Custom prompt template loading

**Pricing (per 1K tokens, Dec 2024):**
- claude-3-5-sonnet-20241022: Input $0.003, Output $0.015
- claude-3-5-haiku-20241022: Input $0.001, Output $0.005

**Key Methods:**
- `process_chunk(chunk, prompt_template, video_title)` - Process single chunk
- `process_all_chunks(chunks, prompt_template, progress_callback)` - Batch processing
- `load_prompt_template(template_path)` - Load base prompt
- `_calculate_cost(input_tokens, output_tokens)` - Cost tracking

**Retry Policy:**
- Max attempts: 3
- Wait: Exponential backoff (1, 2, 4... up to 10s)
- Retry on: RateLimitError, APIConnectionError, InternalServerError

### src/validator.py (NEW - Phase 4)
**Classes:** `OutputValidator`, `ValidationResult`, `ValidationIssue`, `ValidationSeverity`

**Features:**
- Rule-based validation for cleaned transcript output
- Detection of filler words remaining after cleaning
- Context marker detection (should not appear in output)
- Timestamp format validation ([HH:MM:SS])
- Content length ratio checks (truncation/expansion warnings)
- Question count detection (should be converted to statements)
- Validation result aggregation across all chunks

**Validation Rules:**
1. **Filler Detection** - Warns if common fillers remain (uh, um, like, basically, etc.)
2. **Context Markers** - Errors if template markers appear in output
3. **Timestamp Format** - Validates [HH:MM:SS] or [MM:SS] format
4. **Content Length** - Warns if output is <30% or >120% of original
5. **Question Count** - Info if >2 questions (may need conversion)

**Severity Levels:**
- ERROR: Context markers in output, critical issues
- WARNING: Filler words, excessive truncation/expansion
- INFO: Many questions detected

**Key Methods:**
- `validate_chunk(original, cleaned, chunk_index)` - Validate single chunk
- `validate_all(processed_chunks)` - Validate all chunks
- `_check_fillers(text, chunk_index)` - Detect filler words
- `_check_context_markers(text, chunk_index)` - Check for template markers
- `_check_timestamp_format(text, chunk_index)` - Validate timestamps
- `_check_content_length(original, cleaned, chunk_index)` - Length ratio check
- `_check_questions(text, chunk_index)` - Question detection

### src/markdown_writer.py (NEW - Phase 4)
**Classes:** `MarkdownWriter`, `TranscriptMetadata`

**Features:**
- Format and save cleaned transcript as Markdown
- Include metadata header (processed date, model, cost, duration)
- Sanitize filenames from video titles
- Write both .md and -metadata.json files
- Generate preview content for Streamlit display
- Organize content with timestamps and sections

**Output Format:**
```markdown
# Video Title

**Processed:** 2025-12-25
**Model:** claude-3-5-sonnet-20241022
**Cost:** $0.0150
**Duration:** 00:10:30

---

[00:00:00]
Cleaned content here...

[00:05:00]
More content...
```

**Metadata JSON Structure:**
```json
{
  "title": "Video Title",
  "original_duration": "00:10:30",
  "processed_at": "2025-12-25T10:30:00",
  "model": "claude-3-5-sonnet-20241022",
  "cost_usd": 0.015,
  "chunks_processed": 3,
  "tokens": {
    "input": 1500,
    "output": 1200,
    "total": 2700
  }
}
```

**Key Methods:**
- `write(processed_chunks, title, summary, duration)` - Write markdown + metadata
- `_build_markdown(chunks, metadata)` - Build complete markdown document
- `_sanitize_filename(title)` - Create safe filename from title
- `get_content_for_preview(chunks, max_chars)` - Get preview for UI

### src/cost_estimator.py (NEW - Phase 4)
**Classes:** `CostEstimator`, `CostBreakdown`

**Features:**
- Estimate API costs before processing
- Token counting with tiktoken (falls back to char/4)
- Support for multiple Claude models with different pricing
- Processing time estimation
- Cost breakdown per chunk and total

**Pricing Models:**
- claude-3-5-sonnet-20241022: $0.003/1K input, $0.015/1K output
- claude-3-5-haiku-20241022: $0.001/1K input, $0.005/1K output

**Processing Time per Chunk:**
- Sonnet: ~5 seconds per chunk
- Haiku: ~3 seconds per chunk

**Key Methods:**
- `count_tokens(text)` - Count tokens using tiktoken or fallback
- `estimate_chunk_tokens(chunk_text, prompt_template)` - Estimate for single chunk
- `estimate_total(chunks, prompt_template)` - Estimate total cost
- `format_estimate(breakdown)` - Format as readable string

**CostBreakdown Dataclass:**
```python
@dataclass
class CostBreakdown:
    input_tokens: int
    output_tokens_est: int
    input_cost: float
    output_cost: float
    total_cost: float
    chunks: int
    processing_time_minutes: float
```

---

## Development Phases Status

| Phase | Focus | Status | Priority |
|-------|-------|--------|----------|
| 1 | Setup & Dependencies | ✓ Complete | Baseline |
| 2 | Parsing & Chunking | ✓ Complete | Core |
| 3 | LLM Integration | ✓ Complete | Core |
| 4 | Validation & Output | ✓ Complete | Core |
| 5 | Streamlit UI | Pending | Phase 5 |
| 6 | Testing & Polish | Pending | Phase 6 |

### Phase 1 Completion
- [x] Directory structure created
- [x] requirements.txt with correct versions
- [x] .env.example configured
- [x] .gitignore with macOS fixes
- [x] Base prompt extracted to prompts/
- [x] Documentation suite created

### Phase 2 Completion
- [x] TranscriptParser for SRT/VTT formats
- [x] SmartChunker with context preservation
- [x] Unit tests for parser (3 tests)
- [x] Unit tests for chunker (5 tests)
- [x] Test fixtures created
- [x] Code review completed

### Phase 3 Completion
- [x] LLMProcessor with Claude API integration
- [x] ProcessedChunk dataclass for results
- [x] ProcessingError custom exception
- [x] Retry logic with tenacity
- [x] Cost calculation per request
- [x] Support for multiple models (Sonnet, Haiku)
- [x] Progress callback for batch processing
- [x] Unit tests (22 tests, 100% coverage)
- [x] Convenience function: process_transcript()
- [x] Code review completed

### Phase 4 Completion
- [x] OutputValidator with rule-based validation
- [x] ValidationResult, ValidationIssue, ValidationSeverity dataclasses
- [x] MarkdownWriter with metadata support
- [x] TranscriptMetadata dataclass for output tracking
- [x] CostEstimator with tiktoken integration
- [x] CostBreakdown dataclass for cost summaries
- [x] Updated src/__init__.py with new exports
- [x] Unit tests for validator (17 tests, 100% coverage)
- [x] Unit tests for writer (25 tests, 100% coverage)
- [x] Unit tests for cost_estimator (20 tests, 100% coverage)
- [x] Total: 94 passing tests across all modules

---

## Code Quality Metrics

### Phase 4 Assessment
| Aspect | Status | Notes |
|--------|--------|-------|
| **File Organization** | ✓ Good | Modules follow planned structure |
| **Naming Conventions** | ✓ Compliant | snake_case functions, PascalCase classes |
| **Dependencies** | ✓ Vetted | anthropic, tenacity, tiktoken working correctly |
| **Configuration** | ✓ Secure | API keys excluded from version control |
| **Documentation** | ✓ Comprehensive | 4 doc files covering all aspects |
| **Testing** | ✓ Excellent | 94 passing tests, 100% for Phase 4 modules |
| **Error Handling** | ✓ Good | Retry logic, custom exceptions, validation |

---

## Security Posture

### Phase 1-3
- [x] API keys excluded via .gitignore
- [x] .env.example provided as template
- [x] No hardcoded secrets in codebase
- [x] Documentation warns against secret commits
- [x] API error handling with retry logic
- [x] Proper exception handling for processing failures

### Future
- Phase 5: User upload security
- Phase 6: Security testing

---

## Token & Complexity Analysis

### Codebase Tokens
- Total: ~1,500 tokens (Phase 1)
- Largest: base_prompt.txt (629 tokens, 42% of total)
- Framework overhead: requirements.txt + config (90 tokens, 6%)

### Maintainability
- Current state: Simple, easy to understand
- Readiness for Phase 2: Excellent (structure prepared)
- Documentation completeness: 100% for Phase 1

---

## Getting Started

### Prerequisites
- Python 3.9+
- pip package manager
- Anthropic API key

### Setup
```bash
# Clone/enter project
cd transcript_write

# Create virtual environment
python -m venv .venv
source .venv/bin/activate    # macOS/Linux
# or
.venv\Scripts\activate        # Windows

# Install dependencies
pip install -r requirements.txt

# Configure API key
cp .env.example .env
# Edit .env and add your ANTHROPIC_API_KEY
```

### Verification
```bash
python -c "import streamlit; import anthropic; print('Setup OK!')"
```

---

## Next Steps (Phase 5)

1. **Streamlit UI** (`app.py`)
   - File upload component
   - Model selection dropdown
   - Cost estimation display
   - Progress bar with callback
   - Result preview
   - Download button

2. **Integration Testing**
   - End-to-end workflow tests
   - Error handling scenarios
   - User acceptance criteria

---

## References

- **Project Overview & PDR:** `project-overview-pdr.md`
- **Code Standards:** `code-standards.md`
- **System Architecture:** `system-architecture.md`
- **Development Plan:** `../plans/251224-1840-transcript-cleaner-mvp/plan.md`
- **README:** `../README.md` (quick start, project overview)

---

## Notes for Developers

1. **Phase 1-4 complete:** Core pipeline fully implemented
2. **Dependencies verified:** All packages are current and appropriate
3. **Documentation complete:** Can be referenced during Phase 5-6
4. **Code style ready:** Standards documented, patterns established
5. **Security baseline:** Environment variables properly configured
6. **Test coverage:** 94 passing tests, comprehensive validation

Next phase focus: Build Streamlit UI for end-user interaction.
