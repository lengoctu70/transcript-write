# Codebase Summary

**Version:** 0.3.0
**Phase:** 3 - LLM Integration
**Last Updated:** 2025-12-25
**Generated by:** repomix v1.10.2

---

## Project Structure

```
transcript_write/
├── docs/                           # Documentation (this phase)
│   ├── project-overview-pdr.md
│   ├── code-standards.md
│   ├── system-architecture.md
│   └── codebase-summary.md
│
├── src/                            # Source code
│   ├── __init__.py
│   ├── transcript_parser.py        # SRT/VTT parsing
│   ├── chunker.py                  # Smart chunking with context
│   └── llm_processor.py            # Claude API integration
│
├── prompts/                        # Claude system prompts
│   └── base_prompt.txt
│
├── tests/                          # Test suite
│   ├── test_parser.py              # Parser tests
│   ├── test_chunker.py             # Chunker tests
│   ├── test_llm_processor.py       # LLM processor tests
│   └── fixtures/
│       └── sample.srt              # Test fixture
│
├── output/                         # Generated cleaned transcripts
│
├── plans/                          # Development planning
│   ├── 251224-1840-transcript-cleaner-mvp/
│   │   ├── plan.md
│   │   ├── phase-01-setup.md
│   │   ├── phase-02-parsing-chunking.md
│   │   ├── phase-03-llm-integration.md
│   │   ├── phase-04-validation-output.md
│   │   ├── phase-05-streamlit-ui.md
│   │   └── phase-06-testing-polish.md
│   └── reports/
│
├── requirements.txt                # Python dependencies
├── .env.example                    # Configuration template
├── .gitignore                      # Git exclusions
└── README.md                       # Project overview
```

---

## Current State (Phase 3)

### Files Created

**Phase 1:**
1. **requirements.txt** - Python package dependencies
2. **.env.example** - Environment configuration template
3. **.gitignore** - Version control exclusions
4. **src/__init__.py** - Python package initialization
5. **prompts/base_prompt.txt** - Claude system prompt
6. **docs/** - Documentation suite

**Phase 2:**
7. **src/transcript_parser.py** - SRT/VTT parser (127 lines)
8. **src/chunker.py** - Smart chunker with context (122 lines)
9. **tests/test_parser.py** - Parser unit tests (61 lines)
10. **tests/test_chunker.py** - Chunker unit tests (57 lines)
11. **tests/fixtures/sample.srt** - Test fixture (11 lines)

**Phase 3:**
12. **src/llm_processor.py** - Claude API integration (249 lines)
13. **tests/test_llm_processor.py** - LLM processor unit tests (243 lines)

### Key Metrics
| Metric | Value |
|--------|-------|
| Total Files | 13+ |
| Directories | 5 |
| Python Files | 4 (src) + 3 (tests) |
| Configuration Files | 3 |
| Documentation Files | 4 |
| Total Lines of Code | ~1,300 |
| Largest File | test_llm_processor.py (243 lines) |
| Test Coverage | 30 passing tests (100% for llm_processor) |

---

## Dependencies (requirements.txt)

### Core Framework
```
streamlit>=1.29.0
  - Web UI framework for interactive application
  - Version: Stable, supports latest features
```

### LLM Integration
```
anthropic>=0.75.0
  - Official Anthropic Python SDK
  - Required for Claude API access
  - Includes retry and error handling utilities
```

### Parsing & Subtitles
```
pysrt>=1.1.2
  - SRT subtitle file parser
  - Handles timestamp parsing and normalization

webvtt-py>=0.4.6
  - WebVTT subtitle format support
  - Complements pysrt for format coverage
```

### Utilities
```
python-dotenv>=1.0.0
  - Environment variable management
  - Secure API key loading from .env

tiktoken>=0.5.2
  - OpenAI tokenizer (works with GPT/Claude)
  - Accurate token counting for chunks
  - Critical for cost estimation

tenacity>=8.2.3
  - Retry library with exponential backoff
  - Handles transient API failures
  - Improves reliability of API calls
```

### Development & Testing
```
pytest>=7.4.3
  - Testing framework
  - Includes fixtures and parametrization
  - For unit and integration tests
```

### Dependency Philosophy
- **Minimal:** Only essential packages included
- **Stable:** Well-maintained, widely-used libraries
- **Clear Purposes:** Each dependency solves a specific problem
- **Version Flexibility:** Allows patch updates automatically

---

## Configuration Files

### .env.example
```env
ANTHROPIC_API_KEY=sk-ant-xxx
# Optional: OPENAI_API_KEY for future support
```
**Purpose:** Template for required API credentials
**Status:** ✓ Complete
**Notes:** Real .env file is .gitignored (not in repo)

### .gitignore
**Excludes:**
- `.env` - API keys and secrets
- `.venv/`, `venv/` - Virtual environments
- `output/*.md`, `output/*.json` - Generated files
- `__pycache__/`, `*.pyc` - Compiled Python
- `.pytest_cache/` - Test artifacts
- `.DS_Store`, `**/.DS_Store` - macOS artifacts
- `.vscode/`, `.idea/` - IDE configurations

**Status:** ✓ Complete with Phase 1 recommendations

---

## Base Prompt (prompts/base_prompt.txt)

### Summary
A comprehensive system prompt for Claude that defines the rules for cleaning lecture transcripts into study-ready materials for Vietnamese learners.

### Key Sections
1. **ROLE** - Position Claude as senior transcript editor
2. **MISSION** - Aggressive cleaning while preserving meaning
3. **CORE PRINCIPLES** - Rewrite freely, preserve content, improve clarity
4. **LANGUAGE RULES** - English output, Vietnamese audience, keep technical terms
5. **QUESTION HANDLING** - Convert rhetorical questions to declarative statements
6. **EXAMPLES HANDLING** - Keep helpful examples, remove conversational ones
7. **NOISE REMOVAL** - Remove ALL filler, hesitations, and redundant content
8. **STRUCTURE RULES** - Organize by concept, clear paragraphs, improve flow
9. **TIMESTAMPS** - Keep only start timestamps [00:01:15] format
10. **OUTPUT FORMAT** - Markdown, clean paragraphs, no commentary
11. **CONTEXT HANDLING** - Handle chunk continuity with context from previous sections

### Template Variables
- `{{fileName}}` - Source file name (substituted during processing)
- `{{chunkText}}` - Transcript chunk to process (substituted during processing)

### Metrics
- Lines: 121
- Tokens: 629 (based on tiktoken count)
- Size: 2,974 characters

**Status:** ✓ Extracted from README.md, ready for use

---

## Source Code Status

### src/__init__.py
Empty Python package initialization file.

### src/transcript_parser.py (NEW - Phase 2)
**Classes:** `TranscriptParser`, `TranscriptSegment`

**Features:**
- Auto-detect SRT/VTT format
- Parse to structured `TranscriptSegment` dataclass
- Remove HTML tags and duplicates
- Convert to timestamped plain text
- Handle Streamlit file uploads (bytes)

**Key Methods:**
- `parse(file_path)` - Auto-detect and parse
- `parse_from_bytes(content, filename)` - For file uploads
- `to_plain_text(segments)` - Format with timestamps

### src/chunker.py (NEW - Phase 2)
**Classes:** `SmartChunker`, `Chunk`

**Features:**
- Split at sentence/paragraph boundaries
- Context buffer between chunks
- Timestamp extraction per chunk
- Configurable chunk size and overlap

**Key Methods:**
- `chunk_transcript(text)` - Split with context preservation
- `full_text_for_llm` - Build text with context markers

**Chunking Strategy:**
1. Paragraph breaks (double newline)
2. Sentence boundaries (. ! ?)
3. Timestamp markers [HH:MM:SS]
4. Fallback to target position

### src/llm_processor.py (NEW - Phase 3)
**Classes:** `LLMProcessor`, `ProcessedChunk`, `ProcessingError`

**Features:**
- Claude API integration with anthropic SDK
- Retry logic with tenacity (3 attempts, exponential backoff)
- Token counting and cost calculation per request
- Support for multiple Claude models (Sonnet, Haiku)
- Progress callback for batch processing
- Custom prompt template loading

**Pricing (per 1K tokens, Dec 2024):**
- claude-3-5-sonnet-20241022: Input $0.003, Output $0.015
- claude-3-5-haiku-20241022: Input $0.001, Output $0.005

**Key Methods:**
- `process_chunk(chunk, prompt_template, video_title)` - Process single chunk
- `process_all_chunks(chunks, prompt_template, progress_callback)` - Batch processing
- `load_prompt_template(template_path)` - Load base prompt
- `_calculate_cost(input_tokens, output_tokens)` - Cost tracking

**Retry Policy:**
- Max attempts: 3
- Wait: Exponential backoff (1, 2, 4... up to 10s)
- Retry on: RateLimitError, APIConnectionError, InternalServerError

### Future Modules (Phase 4+)
Planned structure (from code-standards.md):
```
src/
├── validator.py       # Quality assurance
├── writer.py          # Markdown generation
└── utils.py           # Shared utilities
```

---

## Development Phases Status

| Phase | Focus | Status | Priority |
|-------|-------|--------|----------|
| 1 | Setup & Dependencies | ✓ Complete | Baseline |
| 2 | Parsing & Chunking | ✓ Complete | Core |
| 3 | LLM Integration | ✓ Complete | Core |
| 4 | Validation & Output | Pending | Phase 4 |
| 5 | Streamlit UI | Pending | Phase 5 |
| 6 | Testing & Polish | Pending | Phase 6 |

### Phase 1 Completion
- [x] Directory structure created
- [x] requirements.txt with correct versions
- [x] .env.example configured
- [x] .gitignore with macOS fixes
- [x] Base prompt extracted to prompts/
- [x] Documentation suite created

### Phase 2 Completion
- [x] TranscriptParser for SRT/VTT formats
- [x] SmartChunker with context preservation
- [x] Unit tests for parser (3 tests)
- [x] Unit tests for chunker (5 tests)
- [x] Test fixtures created
- [x] Code review completed

### Phase 3 Completion
- [x] LLMProcessor with Claude API integration
- [x] ProcessedChunk dataclass for results
- [x] ProcessingError custom exception
- [x] Retry logic with tenacity
- [x] Cost calculation per request
- [x] Support for multiple models (Sonnet, Haiku)
- [x] Progress callback for batch processing
- [x] Unit tests (22 tests, 100% coverage)
- [x] Convenience function: process_transcript()
- [x] Code review completed

---

## Code Quality Metrics

### Phase 3 Assessment
| Aspect | Status | Notes |
|--------|--------|-------|
| **File Organization** | ✓ Good | Modules follow planned structure |
| **Naming Conventions** | ✓ Compliant | snake_case functions, PascalCase classes |
| **Dependencies** | ✓ Vetted | anthropic, tenacity working correctly |
| **Configuration** | ✓ Secure | API keys excluded from version control |
| **Documentation** | ✓ Comprehensive | 4 doc files covering all aspects |
| **Testing** | ✓ Excellent | 30 passing tests, 100% for llm_processor |
| **Error Handling** | ✓ Good | Retry logic, custom exceptions |

---

## Security Posture

### Phase 1-3
- [x] API keys excluded via .gitignore
- [x] .env.example provided as template
- [x] No hardcoded secrets in codebase
- [x] Documentation warns against secret commits
- [x] API error handling with retry logic
- [x] Proper exception handling for processing failures

### Future
- Phase 4: Input validation
- Phase 5: User upload security
- Phase 6: Security testing

---

## Token & Complexity Analysis

### Codebase Tokens
- Total: ~1,500 tokens (Phase 1)
- Largest: base_prompt.txt (629 tokens, 42% of total)
- Framework overhead: requirements.txt + config (90 tokens, 6%)

### Maintainability
- Current state: Simple, easy to understand
- Readiness for Phase 2: Excellent (structure prepared)
- Documentation completeness: 100% for Phase 1

---

## Getting Started

### Prerequisites
- Python 3.9+
- pip package manager
- Anthropic API key

### Setup
```bash
# Clone/enter project
cd transcript_write

# Create virtual environment
python -m venv .venv
source .venv/bin/activate    # macOS/Linux
# or
.venv\Scripts\activate        # Windows

# Install dependencies
pip install -r requirements.txt

# Configure API key
cp .env.example .env
# Edit .env and add your ANTHROPIC_API_KEY
```

### Verification
```bash
python -c "import streamlit; import anthropic; print('Setup OK!')"
```

---

## Next Steps (Phase 4)

1. **Validator** (`src/validator.py`)
   - Quality assurance on cleaned output
   - Detect errors and anomalies
   - Validation result dataclass

2. **Writer** (`src/writer.py`)
   - Format cleaned chunks into Markdown
   - Add timestamps and metadata
   - Write to output file

3. **Tests**
   - Mock validator responses
   - Output formatting tests
   - File writing tests

---

## References

- **Project Overview & PDR:** `project-overview-pdr.md`
- **Code Standards:** `code-standards.md`
- **System Architecture:** `system-architecture.md`
- **Development Plan:** `../plans/251224-1840-transcript-cleaner-mvp/plan.md`
- **README:** `../README.md` (quick start, project overview)

---

## Notes for Developers

1. **Phase 1 is solid:** Architecture well-planned, ready for implementation
2. **Dependencies verified:** All packages are current and appropriate
3. **Documentation complete:** Can be referenced during Phase 2-6
4. **Code style ready:** Standards documented, patterns established
5. **Security baseline:** Environment variables properly configured

Next phase focus: Implement parser and chunker modules with comprehensive tests.
